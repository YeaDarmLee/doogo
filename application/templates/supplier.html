{% include './common/header.html' %}
<style>
  .no-hover {
    pointer-events: none;
  }
</style>

<script>
  /**
   * ===========================================
   *  공통 유틸/상수
   * ===========================================
   */
  const STATE_CODE_MAP = {
    "": "대기",
    P: "대기",
    I: "초대",
    A: "성공",
    E: "에러"
  };
  const STATE_CONTRACT_CODE_MAP = {
    "": "슬랙대기",
    P: "발송대기",
    A: "발송완료",
    SS: "계약완료",
    S: "외부계약",
    E: "에러"
  };

  // HTML 이스케이프(XSS 방지)
  function escapeHtml(s) {
    return String(s || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  // 숫자/정수 검사
  function isNumber(val) { return !isNaN(val) && val !== '' && isFinite(Number(val)); }
  function isInteger(val) { return /^\d+$/.test(String(val)); }

  // 사업자번호(10자리) 검증/표시 포맷
  function isBiz10(val) { return String(val || '').replace(/\D/g, '').length === 10; }
  function formatBizNo(bizno) {
    if (!bizno) return '';
    const d = String(bizno).replace(/\D/g, '');
    if (d.length !== 10) return bizno;
    return d.replace(/(\d{3})(\d{2})(\d{5})/, '$1-$2-$3');
  }

  // 상태/계약상태 렌더
  function renderStateBadge(code) {
    const label = escapeHtml(STATE_CODE_MAP[code] || '');
    if (code === 'E') return `<div class="btn-sm btn-danger no-hover">${label}</div>`;
    if (code === 'P') return `<div class="btn-sm btn-primary no-hover">${label}</div>`;
    if (code === 'I') return `<div class="btn-sm btn-warning no-hover">${label}</div>`;
    return `<div class="btn-sm btn-info no-hover">${label}</div>`;
  }
  function renderContractCell(s) {
    if (s.contractStatus === 'E') {
      return `<button class="btn btn-sm btn-warning ml-1 btn-resend" data-seq="${s.seq}" title="계약서 재발송">계약서 재발송</button>`;
    } else if (s.contractStatus === 'S' || s.contractStatus === 'SS') {
      return `<div class="btn-sm btn-info no-hover">${STATE_CONTRACT_CODE_MAP[s.contractStatus] || ''}</div>`;
    } else if (s.contractStatus === 'P' || s.contractStatus === 'A') {
      return `<div class="btn-sm btn-primary no-hover">${STATE_CONTRACT_CODE_MAP[s.contractStatus] || ''}</div>`;
    }
    return STATE_CONTRACT_CODE_MAP[s.contractStatus] || '';
  }

  // 디바운스
  function debounce(fn, wait) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  // FormData → 객체
  function formToObject(formEl) {
    const fd = new FormData(formEl);
    const obj = {};
    for (const [k, v] of fd.entries()) {
      obj[k] = (typeof v === 'string') ? v.trim() : v;
    }
    return obj;
  }

  /**
   * ===========================================
   *  유효성 규칙
   * ===========================================
   */
  const VALIDATION_RULES = {
    supplierCompanyName: { required: true, max: 20 },
    supplierCode:        { required: true, max: 20 },
    supplierID:          { required: true, minLen: 6 },
    supplierPW:          { required: false, max: 100 },
    supplierURL:         { required: false, url: true, max: 100 },
    supplierManager:     { required: false, max: 10 },
    supplierManagerRank: { required: false, max: 500 },
    supplierNumber:      { required: false },
    supplierEmail:       { required: false, email: true, max: 30 }
  };
  const DETAIL_RULES = {
    businessRegistrationNumber: { required: false, biz10: true },
    bankCode: { required: false }, // 필수로 바꾸려면 true
    accountNumber: { required: false, max: 30 }
  };

  // 기본 형식 검증
  function isValidEmail(val) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val); }
  function isValidURL(val) {
    try {
      const href = /^(https?:)?\/\//i.test(val) ? val : 'http://' + val;
      new URL(href); return true;
    } catch (_) { return false; }
  }

  // 에러/성공 표시
  function clearErrors(formEl) {
    $(formEl).find('.is-invalid').removeClass('is-invalid');
    $(formEl).find('.invalid-feedback').text('');
    $(formEl).find('.is-valid').removeClass('is-valid');
    $(formEl).find('.valid-feedback').text('');
  }
  function showFieldError(inputEl, message) {
    const $el = $(inputEl);
    $el.addClass('is-invalid');
    let fb = $el.siblings('.invalid-feedback');
    if (fb.length === 0) {
      fb = $('<div class="invalid-feedback"></div>');
      $el.after(fb);
    }
    fb.text(message || '유효하지 않은 값입니다.');
    $el.removeClass('is-valid');
    $el.siblings('.valid-feedback').text('');
  }
  function showFieldValid(inputEl) {
    const $el = $(inputEl);
    $el.removeClass('is-invalid');
    $el.siblings('.invalid-feedback').text('');
    $el.addClass('is-valid');
    let vf = $el.siblings('.valid-feedback');
    if (vf.length === 0) {
      vf = $('<div class="valid-feedback"></div>');
      $el.after(vf);
    }
    vf.text('');
  }

  // 단일 필드 검증 (등록 폼 name 기준 + 상세 필드 포함)
  function validateField(formEl, name) {
    const rules = VALIDATION_RULES[name] || DETAIL_RULES[name];
    if (!rules) return { ok: true };

    const inputEl = $(formEl).find(`[name="${name}"]`)[0];
    const raw = (inputEl && inputEl.value ? inputEl.value.trim() : '');

    if (rules.required && !raw) {
      showFieldError(inputEl, '필수 입력 항목입니다.');
      return { ok: false };
    }
    if (!raw) {
      $(inputEl).removeClass('is-invalid is-valid');
      $(inputEl).siblings('.invalid-feedback,.valid-feedback').text('');
      return { ok: true };
    }
    if (rules.max && raw.length > rules.max) {
      showFieldError(inputEl, `최대 ${rules.max}자까지 가능합니다. (현재 ${raw.length}자)`);
      return { ok: false };
    }
    if (rules.minLen && raw.length < rules.minLen) {
      showFieldError(inputEl, `최소 ${rules.minLen}자 이상 입력해 주세요.`);
      return { ok: false };
    }
    if (rules.email && !isValidEmail(raw)) {
      showFieldError(inputEl, '올바른 이메일 형식이 아닙니다.');
      return { ok: false };
    }
    if (rules.url && !isValidURL(raw)) {
      showFieldError(inputEl, '올바른 URL 형식이 아닙니다.');
      return { ok: false };
    }
    if (rules.biz10 && !isBiz10(raw)) {
      showFieldError(inputEl, '사업자등록번호는 숫자 10자리여야 합니다.');
      return { ok: false };
    }
    showFieldValid(inputEl);
    return { ok: true };
  }

  // 전체 폼 검증(등록)
  function validateForm(formEl) {
    clearErrors(formEl);
    const keys = [
      ...Object.keys(VALIDATION_RULES),
      ...Object.keys(DETAIL_RULES)
    ];
    let ok = true;
    keys.forEach((k) => { if (!validateField(formEl, k).ok) ok = false; });

    // 계약 템플릿 조건부 검증
    const t = $('#contractTemplate').val();
    if (t === 'A') {
      const p = $('#contractPercent').val();
      if (!(p !== '' && isNumber(p) && Number(p) >= 0 && Number(p) <= 100)) {
        showFieldError($('#contractPercent'), '0~100 사이의 수수료(%)를 입력해 주세요.');
        ok = false;
      }
    }
    if (t === 'B') {
      const th = $('#contractThreshold').val();
      const under = $('#contractPercentUnder').val();
      const over = $('#contractPercentOver').val();
      if (!(th !== '' && isInteger(th) && Number(th) >= 0)) {
        showFieldError($('#contractThreshold'), '0 이상의 금액을 입력해 주세요.'); ok = false;
      }
      if (!(under !== '' && isNumber(under) && Number(under) >= 0 && Number(under) <= 100)) {
        showFieldError($('#contractPercentUnder'), '0~100 사이의 수수료(%)를 입력해 주세요.'); ok = false;
      }
      if (!(over !== '' && isNumber(over) && Number(over) >= 0 && Number(over) <= 100)) {
        showFieldError($('#contractPercentOver'), '0~100 사이의 수수료(%)를 입력해 주세요.'); ok = false;
      }
    }
    return { ok };
  }

  /**
   * ===========================================
   *  등록 폼: 리셋/라이브검증/제출
   * ===========================================
   */
  function resetForm() {
    // 기본
    $('#supplierCompanyName,#supplierCode,#supplierID,#supplierPW,#supplierURL,#supplierManager,#supplierManagerRank,#supplierNumber,#supplierEmail').val('');
    // 계약
    $('#contractTemplate').val('');
    $('#contractPercent,#contractThreshold,#contractPercentUnder,#contractPercentOver').val('');
    $('#contractSkip').prop('checked', false);
    toggleContractFields();
    // 상세
    $('#businessRegistrationNumber').val('');
    $('#bankCode').val('');
    $('#accountNumber').val('');
    // 검증 제거
    clearErrors(document.getElementById('supplierForm'));
  }

  // 계약 토글(등록)
  function toggleContractFields() {
    const t = $('#contractTemplate').val();
    $('#contractAFields').toggleClass('d-none', t !== 'A');
    $('#contractBFields').toggleClass('d-none', t !== 'B');
  }
  $(document).on('change', '#contractTemplate', toggleContractFields);

  // 등록 폼 라이브 검증
  const liveValidateAdd = debounce(function(e) {
    const form = document.getElementById('supplierForm');
    const name = e.target.name;
    if (!name) return;
    validateField(form, name);
  }, 120);
  $(document).on('input change', '#supplierForm input, #supplierForm select', liveValidateAdd);

  // 등록 제출
  function addSupplier() {
    const form = document.getElementById('supplierForm');
    const { ok } = validateForm(form);
    if (!ok) {
      Swal.fire({ icon: 'error', title: '입력값 확인 필요', text: '빨간 표시된 항목을 수정해 주세요.' });
      return;
    }

    Swal.fire({
      title: '공급사를 등록하시겠습니까?',
      text: '등록 후 Slack 생성 프로세스가 실행됩니다.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '등록',
      cancelButtonText: '취소',
      reverseButtons: true
    }).then((result) => {
      if (!result.isConfirmed) return;

      const fd = new FormData(form);
      $.ajax({
        type: 'post',
        url: '/supplier/ajax/addSupplier',
        data: fd,
        dataType: 'json',
        processData: false,
        contentType: false,
        cache: false
      }).done(function(res) {
        if (res.code === 20000) {
          alertStartHtml('success', '공급사 등록 완료', '공급사 등록이 완료되었습니다.<br>Slack 생성 프로세스가 시작됩니다.')
          .then(function() {
            $('#addSupplierClose').click();
            location.reload();
          });
        } else {
          alertStart('error', '공급사 등록 실패', res.message || '등록 처리에 실패했습니다.');
        }
      }).fail(function(xhr) {
        const r = xhr.responseJSON || {};
        alertStart('error', '공급사 등록 실패', r.message || '등록 처리에 실패했습니다.');
      });
    });
  }

  /**
   * ===========================================
   *  수정: 프리필/검증/저장
   * ===========================================
   */
  // 수정 버튼
  $(document).on('click', '.btn-edit', function (e) {
    e.preventDefault();
    const seq = $(this).data('seq');
    if (!seq) return;
    openEditModal(seq);
  });

  // 계약 토글(수정)
  function toggleContractFieldsEdit() {
    const t = $('#editContractTemplate').val();
    $('#editContractAFields').toggleClass('d-none', t !== 'A');
    $('#editContractBFields').toggleClass('d-none', t !== 'B');
  }
  $(document).on('change', '#editContractTemplate', toggleContractFieldsEdit);

  // 수정 모달 오픈 & 프리필
  function openEditModal(seq) {
    $.getJSON(`/supplier/ajax/${seq}`, function(res) {
      if (res.code !== 20000) {
        alertStart('error', '조회 실패', '공급사 정보를 불러오지 못했습니다.');
        return;
      }
      const f = document.getElementById('editSupplierForm');
      const it = res.item || {};
      const d = it.detail || {};

      // 기본
      f.seq.value = it.seq;
      f.updatedAt.value = it.updatedAt || '';
      f.companyName.value = it.companyName || '';
      f.supplierCode.value = it.supplierCode || '';
      f.supplierID.value = it.supplierID || '';
      f.supplierPW.value = ''; // 보안상 공란 유지
      f.supplierURL.value = it.supplierURL || '';
      f.manager.value = it.manager || '';
      f.managerRank.value = it.managerRank || '';
      f.number.value = it.number || '';
      f.email.value = it.email || '';

      // 상세
      f.businessRegistrationNumber.value = d.businessRegistrationNumber || '';
      $(f.bankCode).val(d.bankCode || '');
      f.accountNumber.value = d.accountNumber || '';

      // 계약
      $('#editContractTemplate').val(it.contractTemplate || '');
      $('#editContractPercent').val(it.contractPercent ?? '');
      $('#editContractThreshold').val(it.contractThreshold ?? '');
      $('#editContractPercentUnder').val(it.contractPercentUnder ?? '');
      $('#editContractPercentOver').val(it.contractPercentOver ?? '');
      $('#editContractSkip').prop('checked', String(it.contractSkip || '0') === '1');

      toggleContractFieldsEdit();
      clearErrors(f);
      $('#editSupplier').modal('show');
    }).fail(() => {
      alertStart('error', '조회 실패', '공급사 정보를 불러오지 못했습니다.');
    });
  }

  // 수정 폼 라이브 검증 (등록 룰 매핑)
  const liveValidateEdit = debounce(function(e) {
    const f = document.getElementById('editSupplierForm');
    const name = e.target.name;
    if (!name) return;

    const bridge = {
      companyName: 'supplierCompanyName',
      supplierCode: 'supplierCode',
      supplierID: 'supplierID',
      supplierPW: 'supplierPW',
      supplierURL: 'supplierURL',
      manager: 'supplierManager',
      managerRank: 'supplierManagerRank',
      number: 'supplierNumber',
      email: 'supplierEmail',
      businessRegistrationNumber: 'businessRegistrationNumber',
      bankCode: 'bankCode',
      accountNumber: 'accountNumber'
    };
    const key = bridge[name] || name;
    const formKeyRules = VALIDATION_RULES[key] || DETAIL_RULES[key];
    if (!formKeyRules) return;

    const inputEl = $(f).find(`[name="${name}"]`)[0];
    const raw = (inputEl && inputEl.value ? inputEl.value.trim() : '');

    if (formKeyRules.required && !raw && name !== 'supplierPW') { showFieldError(inputEl, '필수 입력 항목입니다.'); return; }
    if (!raw) { $(inputEl).removeClass('is-invalid is-valid'); return; }
    if (formKeyRules.max && raw.length > formKeyRules.max) { showFieldError(inputEl, `최대 ${formKeyRules.max}자까지 가능합니다. (현재 ${raw.length}자)`); return; }
    if (formKeyRules.minLen && raw.length < formKeyRules.minLen) { showFieldError(inputEl, `최소 ${formKeyRules.minLen}자 이상 입력해 주세요.`); return; }
    if (formKeyRules.email && !isValidEmail(raw)) { showFieldError(inputEl, '올바른 이메일 형식이 아닙니다.'); return; }
    if (formKeyRules.url && !isValidURL(raw)) { showFieldError(inputEl, '올바른 URL 형식이 아닙니다.'); return; }
    if (formKeyRules.biz10 && !isBiz10(raw)) { showFieldError(inputEl, '사업자등록번호는 숫자 10자리여야 합니다.'); return; }
    showFieldValid(inputEl);
  }, 120);
  $(document).on('input change', '#editSupplierForm input, #editSupplierForm select', liveValidateEdit);

  // 수정 저장
  function saveEditSupplier() {
    const f = document.getElementById('editSupplierForm');
    clearErrors(f);

    // 필수/형식 체크
    let ok = true;
    if (!f.companyName.value.trim()) { showFieldError(f.companyName, '필수 입력 항목입니다.'); ok = false; }
    if (!f.supplierID.value.trim() || f.supplierID.value.trim().length < 6) { showFieldError(f.supplierID, 'ID는 6자 이상 입력해 주세요.'); ok = false; }

    // 계약 체크
    const t = $('#editContractTemplate').val();
    if (t === 'A') {
      const p = $('#editContractPercent').val();
      if (!(p !== '' && isNumber(p) && Number(p) >= 0 && Number(p) <= 100)) {
        showFieldError($('#editContractPercent'), '0~100 사이의 수수료(%)를 입력해 주세요.'); ok = false;
      }
    }
    if (t === 'B') {
      const th = $('#editContractThreshold').val();
      const under = $('#editContractPercentUnder').val();
      const over = $('#editContractPercentOver').val();
      if (!(th !== '' && isInteger(th) && Number(th) >= 0)) { showFieldError($('#editContractThreshold'), '0 이상의 금액을 입력해 주세요.'); ok = false; }
      if (!(under !== '' && isNumber(under) && Number(under) >= 0 && Number(under) <= 100)) { showFieldError($('#editContractPercentUnder'), '0~100 사이의 수수료(%)를 입력해 주세요.'); ok = false; }
      if (!(over !== '' && isNumber(over) && Number(over) >= 0 && Number(over) <= 100)) { showFieldError($('#editContractPercentOver'), '0~100 사이의 수수료(%)를 입력해 주세요.'); ok = false; }
    }

    // 상세 체크(선택이지만 형식 보정)
    const biz = f.businessRegistrationNumber.value;
    if (biz && !isBiz10(biz)) { showFieldError(f.businessRegistrationNumber, '사업자등록번호는 숫자 10자리여야 합니다.'); ok = false; }
    if (!ok) {
      Swal.fire({ icon: 'error', title: '입력값 확인 필요', text: '빨간 표시된 항목을 수정해 주세요.' });
      return;
    }

    const payload = {
      seq: f.seq.value,
      updatedAt: f.updatedAt.value,
      companyName: f.companyName.value.trim(),
      supplierCode: f.supplierCode.value.trim(),
      supplierID: f.supplierID.value.trim(),
      supplierPW: f.supplierPW.value.trim(), // 공란이면 서버에서 무시
      supplierURL: f.supplierURL.value.trim(),
      manager: f.manager.value.trim(),
      managerRank: f.managerRank.value.trim(),
      number: f.number.value.trim(),
      email: f.email.value.trim(),
      // 상세
      businessRegistrationNumber: biz,
      bankCode: f.bankCode.value,
      accountNumber: f.accountNumber.value.trim(),
      // 계약
      contractTemplate: t,
      contractPercent: $('#editContractPercent').val(),
      contractThreshold: $('#editContractThreshold').val(),
      contractPercentUnder: $('#editContractPercentUnder').val(),
      contractPercentOver: $('#editContractPercentOver').val(),
      contractSkip: $('#editContractSkip').is(':checked') ? '1' : '0'
    };

    $.ajax({
      url: '/supplier/ajax/update',
      method: 'POST',
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify(payload)
    }).done(function(res) {
      if (res.code === 20000) {
        alertStart('success', '수정 완료', '공급사 정보가 저장되었습니다.')
        .then(function () {
          $('#editSupplier').modal('hide');
          location.reload();
        });
      } else if (res.code === 40900) {
        alertStart('warning', '동시 수정 감지', res.message || '다른 사용자가 먼저 수정했습니다. 새로고침 후 다시 시도해 주세요.');
      } else if (res.code === 40001) {
        alertStart('error', '검증 실패', '입력값을 확인해 주세요.');
      } else {
        alertStart('error', '저장 실패', res.message || '예기치 못한 오류가 발생했습니다.');
      }
    }).fail(function(xhr) {
      const r = xhr.responseJSON || {};
      alertStart('error', '저장 실패', r.message || '예기치 못한 오류가 발생했습니다.');
    });
  }

  // 계약서 재발송
  $(document).on('click', '.btn-resend', function (e) {
    e.preventDefault();
    const seq = $(this).data('seq');
    if (!seq) return;

    Swal.fire({
      icon: 'warning',
      title: '계약서 재발송',
      text: '해당 공급사에 계약서를 다시 발송할까요?',
      showCancelButton: true,
      confirmButtonText: '재발송',
      cancelButtonText: '취소',
      reverseButtons: true
    }).then((res) => {
      if (!res.isConfirmed) return;

      $.ajax({
        url: '/supplier/ajax/contract/resend',
        method: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({ seq })
      }).done((r) => {
        if (r.code === 20000) {
          alertStart('success', '재발송 요청 완료', '계약서 재발송이 요청되었습니다.')
          .then(function () { location.reload(); });
        } else {
          alertStart('error', '재발송 실패', r.message || '계약서 재발송 처리에 실패했습니다.');
        }
      }).fail(() => {
        alertStart('error', '재발송 실패', '계약서 재발송 처리에 실패했습니다.');
      });
    });
  });

  // 페이지 로드 훅(필요 시)
  $(function(){});
</script>

<body id="page-top">
  <div id="wrapper">
    {% include './common/sidebar.html' %}

    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <div class="container-fluid">

          <h1 class="h3 mb-2 text-gray-800">공급사 관리</h1>
          <p class="mb-4">
            공급사 등록, 수정 및 계약서 관리 기능을 제공합니다.<br>
            신규 공급사를 등록하면 Slack 채널이 자동 생성되고, 계약 진행 상태를 확인할 수 있습니다.
          </p>

          <div class="card shadow mb-4" style="zoom:0.9;">
            <div class="card-header py-3 d-sm-flex align-items-center justify-content-between">
              <h6 class="m-0 font-weight-bold text-primary">공급사 리스트</h6>
              <a class="d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                 href="javascript:resetForm()"
                 data-toggle="modal" data-target="#addSupplier">공급사 등록</a>
            </div>

            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered text-center" id="dataTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>No</th>
                      <th>회사명</th>
                      <th>사업자번호</th>
                      <th>CAFE24 코드</th>
                      <th>Slack</th>
                      <th>계약서 작성여부</th>
                      <th>공급사 ID</th>
                      <th>담당자명</th>
                      <th>직책</th>
                      <th>연락처</th>
                      <th>이메일</th>
                      <th>정산은행</th>
                      <th>계좌번호</th>
                      <th>기능</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for supplier in supplierList %}
                      <tr data-seq="{{ supplier.seq }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ supplier.companyName }}</td>
                        <td>{{ supplier.detail.businessRegistrationNumber | bizno_format }}</td>
                        <td><div class="btn-sm btn-secondary no-hover">{{ supplier.supplierCode }}</div></td>
                        <td>
                          {% if supplier.stateCode == 'E' %}
                          <div class="btn-sm btn-danger no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% elif supplier.stateCode == 'P' %}
                          <div class="btn-sm btn-primary no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% elif supplier.stateCode == 'I' %}
                          <div class="btn-sm btn-warning no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% else %}
                          <div class="btn-sm btn-info no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% endif %}
                        </td>
                        <td>
                          {% if supplier.contractStatus in ['SS', 'S'] %}
                            <div class="btn-sm btn-info no-hover">{{ supplier.contractStatus | contractState_text }}</div>
                          {% elif supplier.contractStatus in ['P', 'A'] %}
                            <div class="btn-sm btn-primary no-hover">{{ supplier.contractStatus | contractState_text }}</div>
                          {% elif supplier.contractStatus == 'E' %}
                            <button class="btn btn-sm btn-warning ml-1 btn-resend"
                                    data-seq="{{ supplier.seq }}" title="계약서 재발송">
                              계약서 재발송
                            </button>
                          {% else %}
                            {{ supplier.contractStatus | contractState_text }}
                          {% endif %}
                        </td>
                        <td>{{ supplier.supplierID }}</td>
                        <td>{{ supplier.manager }}</td>
                        <td>{{ supplier.managerRank }}</td>
                        <td>{{ supplier.number }}</td>
                        <td>{{ supplier.email }}</td>
                        <td>{{ supplier.detail.bankCode | bankState_text }}</td>
                        <td>{{ supplier.detail.accountNumber }}</td>
                        <td>
                          <a href="#"
                             class="d-sm-inline-block btn btn-sm btn-primary shadow-sm btn-edit"
                             data-seq="{{ supplier.seq }}">수정</a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>

      {% include './common/copyright.html' %}
    </div>
  </div>

  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- 등록 모달 -->
  <div class="modal fade" id="addSupplier" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">공급사 등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span>×</span></button>
        </div>

        <div class="modal-body">
          <form class="supplierForm" id="supplierForm" novalidate>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierCompanyName" name="supplierCompanyName" placeholder="회사명" maxlength="20" required>
              <div class="invalid-feedback">회사명은 필수이며 최대 20자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierCode" name="supplierCode" placeholder="CAFE24 코드" maxlength="20" required>
              <div class="invalid-feedback">Cafe24 코드는 필수이며 최대 20자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierID" name="supplierID" placeholder="공급사 ID(최소 6자)" minlength="6" required>
              <div class="invalid-feedback">공급사 ID는 최소 6자 이상 입력해 주세요.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierPW" name="supplierPW" placeholder="공급사 PW" maxlength="100">
              <div class="invalid-feedback">PW는 최대 100자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierURL" name="supplierURL" placeholder="자사몰 URL" maxlength="100">
              <div class="invalid-feedback">올바른 URL 형식이 아닙니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierManager" name="supplierManager" placeholder="담당자명" maxlength="10">
              <div class="invalid-feedback">담당자명은 최대 10자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierManagerRank" name="supplierManagerRank" placeholder="직책" maxlength="500">
              <div class="invalid-feedback">직책은 최대 500자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierNumber" name="supplierNumber" placeholder="연락처">
              <div class="invalid-feedback">유효한 연락처를 입력해 주세요.</div>
            </div>
            <div class="form-group">
              <input type="email" class="form-control form-control-user" id="supplierEmail" name="supplierEmail" placeholder="이메일" maxlength="30">
              <div class="invalid-feedback">올바른 이메일 형식이 아닙니다.</div>
            </div>

            <!-- 계약(등록) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <label class="small text-muted mb-1">계약서 선택</label>
                <select class="form-control" id="contractTemplate" name="contractTemplate">
                  <option value="">선택안함</option>
                  <option value="A">A. 단일 수수료(%)</option>
                  <option value="B">B. 특정금액 기준 구간별 수수료</option>
                </select>
              </div>
              <div id="contractAFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control form-control-user" id="contractPercent" name="contractPercent" placeholder="수수료(%)">
                  <div class="invalid-feedback">0~100 사이의 수수료(%)를 입력해 주세요.</div>
                </div>
              </div>
              <div id="contractBFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="1" min="0" class="form-control form-control-user" id="contractThreshold" name="contractThreshold" placeholder="특정 금액(원)">
                  <div class="invalid-feedback">0 이상의 금액을 입력해 주세요.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control form-control-user" id="contractPercentUnder" name="contractPercentUnder" placeholder="이하일 때 수수료(%)">
                  <div class="invalid-feedback">0~100 사이의 수수료(%)를 입력해 주세요.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control form-control-user" id="contractPercentOver" name="contractPercentOver" placeholder="초과일 때 수수료(%)">
                  <div class="invalid-feedback">0~100 사이의 수수료(%)를 입력해 주세요.</div>
                </div>
              </div>
              <div class="form-group form-check mt-2">
                <input type="checkbox" class="form-check-input" id="contractSkip" name="contractSkip" value="1">
                <label class="form-check-label" for="contractSkip">이미 계약서를 제출한 업체(발송 스킵)</label>
              </div>
            </div>

            <!-- 정산(등록) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <input type="text" class="form-control form-control-user" id="businessRegistrationNumber" name="businessRegistrationNumber" placeholder="사업자등록번호 (숫자만 10자리)" maxlength="12">
                <div class="invalid-feedback">사업자등록번호는 숫자 10자리여야 합니다.</div>
              </div>
              <div class="form-group">
                <select class="form-control" id="bankCode" name="bankCode">
                  <option value="">정산은행 선택</option>
                  <option value="088">신한은행</option>
                  <option value="004">국민은행</option>
                  <option value="081">하나은행</option>
                  <option value="011">농협은행</option>
                  <option value="020">우리은행</option>
                </select>
                <div class="invalid-feedback">정산은행을 선택해 주세요.</div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control form-control-user" id="accountNumber" name="accountNumber" placeholder="계좌번호 (숫자/‘-’ 허용)" maxlength="30">
                <div class="invalid-feedback">유효한 계좌번호를 입력해 주세요.</div>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" id="addSupplierClose" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-primary" href="javascript:addSupplier()">등록</a>
        </div>

      </div>
    </div>
  </div>

  <!-- 수정 모달 -->
  <div class="modal fade" id="editSupplier" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">공급사 수정</h5>
          <button class="close" type="button" data-dismiss="modal"><span>×</span></button>
        </div>

        <div class="modal-body">
          <form id="editSupplierForm" novalidate>
            <input type="hidden" name="seq">
            <input type="hidden" name="updatedAt">

            <div class="form-group">
              <input type="text" class="form-control" name="companyName" placeholder="회사명" maxlength="20" required>
              <div class="invalid-feedback">회사명은 필수이며 최대 20자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="supplierCode" placeholder="CAFE24 코드" maxlength="20" required>
              <div class="invalid-feedback">CAFE24 코드는 필수이며 최대 20자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="supplierID" placeholder="공급사 ID(최소 6자)" minlength="6" required>
              <div class="invalid-feedback">공급사 ID는 최소 6자 이상입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="supplierPW" placeholder="공급사 PW(변경 시에만 입력)" maxlength="100">
              <div class="invalid-feedback">PW는 최대 100자입니다.</div>
            </div>

            <div class="form-group">
              <input type="text" class="form-control" name="supplierURL" placeholder="자사몰 URL" maxlength="100">
              <div class="invalid-feedback">올바른 URL 형식이 아닙니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="manager" placeholder="담당자명" maxlength="10">
              <div class="invalid-feedback">담당자명은 최대 10자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="managerRank" placeholder="직책" maxlength="500">
              <div class="invalid-feedback">직책은 최대 500자입니다.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="number" placeholder="연락처">
              <div class="invalid-feedback">유효한 연락처를 입력해 주세요.</div>
            </div>
            <div class="form-group">
              <input type="email" class="form-control" name="email" placeholder="이메일" maxlength="30">
              <div class="invalid-feedback">올바른 이메일 형식이 아닙니다.</div>
            </div>

            <!-- 계약(수정) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <label class="small text-muted mb-1">계약서 선택</label>
                <select class="form-control" id="editContractTemplate" name="contractTemplate">
                  <option value="">선택안함</option>
                  <option value="A">A. 단일 수수료(%)</option>
                  <option value="B">B. 특정금액 기준 구간별 수수료</option>
                </select>
              </div>
              <div id="editContractAFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control" id="editContractPercent" name="contractPercent" placeholder="수수료(%)">
                  <div class="invalid-feedback">0~100 사이의 수수료(%)를 입력해 주세요.</div>
                </div>
              </div>
              <div id="editContractBFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="1" min="0" class="form-control" id="editContractThreshold" name="contractThreshold" placeholder="특정 금액(원)">
                  <div class="invalid-feedback">0 이상의 금액을 입력해 주세요.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control" id="editContractPercentUnder" name="contractPercentUnder" placeholder="이하일 때 수수료(%)">
                  <div class="invalid-feedback">0~100 사이의 수수료(%)를 입력해 주세요.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control" id="editContractPercentOver" name="contractPercentOver" placeholder="초과일 때 수수료(%)">
                  <div class="invalid-feedback">0~100 사이의 수수료(%)를 입력해 주세요.</div>
                </div>
              </div>
              <div class="form-group form-check mt-2">
                <input type="checkbox" class="form-check-input" id="editContractSkip" name="contractSkip" value="1">
                <label class="form-check-label" for="editContractSkip">이미 계약서를 제출한 업체(발송 스킵)</label>
              </div>
            </div>

            <!-- 정산(수정) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <input type="text" class="form-control" name="businessRegistrationNumber" placeholder="사업자등록번호 (숫자만 10자리)" maxlength="12">
                <div class="invalid-feedback">사업자등록번호는 숫자 10자리여야 합니다.</div>
              </div>
              <div class="form-group">
                <select class="form-control" name="bankCode">
                  <option value="">정산은행 선택</option>
                  <option value="088">신한은행</option>
                  <option value="004">국민은행</option>
                  <option value="081">하나은행</option>
                  <option value="011">농협은행</option>
                  <option value="020">우리은행</option>
                </select>
                <div class="invalid-feedback">정산은행을 선택해 주세요.</div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control" name="accountNumber" placeholder="계좌번호 (숫자/‘-’ 허용)" maxlength="30">
                <div class="invalid-feedback">유효한 계좌번호를 입력해 주세요.</div>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <button class="btn btn-primary" id="btnUpdateSupplier" type="button" onclick="saveEditSupplier()">저장</button>
        </div>

      </div>
    </div>
  </div>

  {% include './common/footer.html' %}
