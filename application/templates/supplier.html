{% include './common/header.html' %}
<style>
  .no-hover {
    pointer-events: none;
  }
</style>

<script>
  /**
   * ===========================================
   *  ê³µí†µ ìœ í‹¸/ìƒìˆ˜
   * ===========================================
   */
  const STATE_CODE_MAP = {
    "": "ëŒ€ê¸°",
    P: "ëŒ€ê¸°",
    I: "ì´ˆëŒ€",
    A: "ì„±ê³µ",
    E: "ì—ëŸ¬"
  };
  const STATE_CONTRACT_CODE_MAP = {
    "": "ìŠ¬ë™ëŒ€ê¸°",
    P: "ë°œì†¡ëŒ€ê¸°",
    A: "ë°œì†¡ì™„ë£Œ",
    SS: "ê³„ì•½ì™„ë£Œ",
    S: "ì™¸ë¶€ê³„ì•½",
    E: "ì—ëŸ¬"
  };

  // HTML ì´ìŠ¤ì¼€ì´í”„(XSS ë°©ì§€)
  function escapeHtml(s) {
    return String(s || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  // ìˆ«ì/ì •ìˆ˜ ê²€ì‚¬
  function isNumber(val) { return !isNaN(val) && val !== '' && isFinite(Number(val)); }
  function isInteger(val) { return /^\d+$/.test(String(val)); }

  // ì‚¬ì—…ìë²ˆí˜¸(10ìë¦¬) ê²€ì¦/í‘œì‹œ í¬ë§·
  function isBiz10(val) { return String(val || '').replace(/\D/g, '').length === 10; }
  function formatBizNo(bizno) {
    if (!bizno) return '';
    const d = String(bizno).replace(/\D/g, '');
    if (d.length !== 10) return bizno;
    return d.replace(/(\d{3})(\d{2})(\d{5})/, '$1-$2-$3');
  }

  // ìƒíƒœ/ê³„ì•½ìƒíƒœ ë Œë”
  function renderStateBadge(code) {
    const label = escapeHtml(STATE_CODE_MAP[code] || '');
    if (code === 'E') return `<div class="btn-sm btn-danger no-hover">${label}</div>`;
    if (code === 'P') return `<div class="btn-sm btn-primary no-hover">${label}</div>`;
    if (code === 'I') return `<div class="btn-sm btn-warning no-hover">${label}</div>`;
    return `<div class="btn-sm btn-info no-hover">${label}</div>`;
  }
  function renderContractCell(s) {
    if (s.contractStatus === 'E') {
      return `<button class="btn btn-sm btn-warning ml-1 btn-resend" data-seq="${s.seq}" title="ê³„ì•½ì„œ ì¬ë°œì†¡">ê³„ì•½ì„œ ì¬ë°œì†¡</button>`;
    } else if (s.contractStatus === 'S' || s.contractStatus === 'SS') {
      return `<div class="btn-sm btn-info no-hover">${STATE_CONTRACT_CODE_MAP[s.contractStatus] || ''}</div>`;
    } else if (s.contractStatus === 'P' || s.contractStatus === 'A') {
      return `<div class="btn-sm btn-primary no-hover">${STATE_CONTRACT_CODE_MAP[s.contractStatus] || ''}</div>`;
    }
    return STATE_CONTRACT_CODE_MAP[s.contractStatus] || '';
  }

  // ë””ë°”ìš´ìŠ¤
  function debounce(fn, wait) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  // FormData â†’ ê°ì²´
  function formToObject(formEl) {
    const fd = new FormData(formEl);
    const obj = {};
    for (const [k, v] of fd.entries()) {
      obj[k] = (typeof v === 'string') ? v.trim() : v;
    }
    return obj;
  }

  /**
   * ===========================================
   *  ìœ íš¨ì„± ê·œì¹™
   * ===========================================
   */
  const VALIDATION_RULES = {
    supplierCompanyName: { required: true, max: 20 },
    supplierCode:        { required: true, max: 20 },
    supplierID:          { required: true, minLen: 6 },
    supplierPW:          { required: false, max: 100 },
    supplierURL:         { required: false, url: true, max: 100 },
    supplierManager:     { required: false, max: 10 },
    supplierManagerRank: { required: false, max: 500 },
    supplierNumber:      { required: false },
    supplierEmail:       { required: false, email: true, max: 30 }
  };
  const DETAIL_RULES = {
    businessRegistrationNumber: { required: false, biz10: true },
    bankCode: { required: false }, // í•„ìˆ˜ë¡œ ë°”ê¾¸ë ¤ë©´ true
    accountNumber: { required: false, max: 30 }
  };

  // ê¸°ë³¸ í˜•ì‹ ê²€ì¦
  function isValidEmail(val) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val); }
  function isValidURL(val) {
    try {
      const href = /^(https?:)?\/\//i.test(val) ? val : 'http://' + val;
      new URL(href); return true;
    } catch (_) { return false; }
  }

  // ì—ëŸ¬/ì„±ê³µ í‘œì‹œ
  function clearErrors(formEl) {
    $(formEl).find('.is-invalid').removeClass('is-invalid');
    $(formEl).find('.invalid-feedback').text('');
    $(formEl).find('.is-valid').removeClass('is-valid');
    $(formEl).find('.valid-feedback').text('');
  }
  function showFieldError(inputEl, message) {
    const $el = $(inputEl);
    $el.addClass('is-invalid');
    let fb = $el.siblings('.invalid-feedback');
    if (fb.length === 0) {
      fb = $('<div class="invalid-feedback"></div>');
      $el.after(fb);
    }
    fb.text(message || 'ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì…ë‹ˆë‹¤.');
    $el.removeClass('is-valid');
    $el.siblings('.valid-feedback').text('');
  }
  function showFieldValid(inputEl) {
    const $el = $(inputEl);
    $el.removeClass('is-invalid');
    $el.siblings('.invalid-feedback').text('');
    $el.addClass('is-valid');
    let vf = $el.siblings('.valid-feedback');
    if (vf.length === 0) {
      vf = $('<div class="valid-feedback"></div>');
      $el.after(vf);
    }
    vf.text('');
  }

  // ë‹¨ì¼ í•„ë“œ ê²€ì¦ (ë“±ë¡ í¼ name ê¸°ì¤€ + ìƒì„¸ í•„ë“œ í¬í•¨)
  function validateField(formEl, name) {
    const rules = VALIDATION_RULES[name] || DETAIL_RULES[name];
    if (!rules) return { ok: true };

    const inputEl = $(formEl).find(`[name="${name}"]`)[0];
    const raw = (inputEl && inputEl.value ? inputEl.value.trim() : '');

    if (rules.required && !raw) {
      showFieldError(inputEl, 'í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
      return { ok: false };
    }
    if (!raw) {
      $(inputEl).removeClass('is-invalid is-valid');
      $(inputEl).siblings('.invalid-feedback,.valid-feedback').text('');
      return { ok: true };
    }
    if (rules.max && raw.length > rules.max) {
      showFieldError(inputEl, `ìµœëŒ€ ${rules.max}ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í˜„ì¬ ${raw.length}ì)`);
      return { ok: false };
    }
    if (rules.minLen && raw.length < rules.minLen) {
      showFieldError(inputEl, `ìµœì†Œ ${rules.minLen}ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.`);
      return { ok: false };
    }
    if (rules.email && !isValidEmail(raw)) {
      showFieldError(inputEl, 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
      return { ok: false };
    }
    if (rules.url && !isValidURL(raw)) {
      showFieldError(inputEl, 'ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
      return { ok: false };
    }
    if (rules.biz10 && !isBiz10(raw)) {
      showFieldError(inputEl, 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ì 10ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
      return { ok: false };
    }
    showFieldValid(inputEl);
    return { ok: true };
  }

  // ì „ì²´ í¼ ê²€ì¦(ë“±ë¡)
  function validateForm(formEl) {
    clearErrors(formEl);
    const keys = [
      ...Object.keys(VALIDATION_RULES),
      ...Object.keys(DETAIL_RULES)
    ];
    let ok = true;
    keys.forEach((k) => { if (!validateField(formEl, k).ok) ok = false; });

    // ê³„ì•½ í…œí”Œë¦¿ ì¡°ê±´ë¶€ ê²€ì¦
    const t = $('#contractTemplate').val();
    if (t === 'A') {
      const p = $('#contractPercent').val();
      if (!(p !== '' && isNumber(p) && Number(p) >= 0 && Number(p) <= 100)) {
        showFieldError($('#contractPercent'), '0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        ok = false;
      }
    }
    if (t === 'B') {
      const th = $('#contractThreshold').val();
      const under = $('#contractPercentUnder').val();
      const over = $('#contractPercentOver').val();
      if (!(th !== '' && isInteger(th) && Number(th) >= 0)) {
        showFieldError($('#contractThreshold'), '0 ì´ìƒì˜ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false;
      }
      if (!(under !== '' && isNumber(under) && Number(under) >= 0 && Number(under) <= 100)) {
        showFieldError($('#contractPercentUnder'), '0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false;
      }
      if (!(over !== '' && isNumber(over) && Number(over) >= 0 && Number(over) <= 100)) {
        showFieldError($('#contractPercentOver'), '0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false;
      }
    }
    return { ok };
  }

  /**
   * ===========================================
   *  ë“±ë¡ í¼: ë¦¬ì…‹/ë¼ì´ë¸Œê²€ì¦/ì œì¶œ
   * ===========================================
   */
  function resetForm() {
    // ê¸°ë³¸
    $('#supplierCompanyName,#supplierCode,#supplierID,#supplierPW,#supplierURL,#supplierManager,#supplierManagerRank,#supplierNumber,#supplierEmail').val('');
    // ê³„ì•½
    $('#contractTemplate').val('');
    $('#contractPercent,#contractThreshold,#contractPercentUnder,#contractPercentOver').val('');
    $('#contractSkip').prop('checked', false);
    toggleContractFields();
    // ìƒì„¸
    $('#businessRegistrationNumber').val('');
    $('#bankCode').val('');
    $('#accountNumber').val('');
    // ê²€ì¦ ì œê±°
    clearErrors(document.getElementById('supplierForm'));
  }

  // ê³„ì•½ í† ê¸€(ë“±ë¡)
  function toggleContractFields() {
    const t = $('#contractTemplate').val();
    $('#contractAFields').toggleClass('d-none', t !== 'A');
    $('#contractBFields').toggleClass('d-none', t !== 'B');
  }
  $(document).on('change', '#contractTemplate', toggleContractFields);

  // ë“±ë¡ í¼ ë¼ì´ë¸Œ ê²€ì¦
  const liveValidateAdd = debounce(function(e) {
    const form = document.getElementById('supplierForm');
    const name = e.target.name;
    if (!name) return;
    validateField(form, name);
  }, 120);
  $(document).on('input change', '#supplierForm input, #supplierForm select', liveValidateAdd);

  // ë“±ë¡ ì œì¶œ
  function addSupplier() {
    const form = document.getElementById('supplierForm');
    const { ok } = validateForm(form);
    if (!ok) {
      Swal.fire({ icon: 'error', title: 'ì…ë ¥ê°’ í™•ì¸ í•„ìš”', text: 'ë¹¨ê°„ í‘œì‹œëœ í•­ëª©ì„ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.' });
      return;
    }

    Swal.fire({
      title: 'ê³µê¸‰ì‚¬ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      text: 'ë“±ë¡ í›„ Slack ìƒì„± í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'ë“±ë¡',
      cancelButtonText: 'ì·¨ì†Œ',
      reverseButtons: true
    }).then((result) => {
      if (!result.isConfirmed) return;

      const fd = new FormData(form);
      $.ajax({
        type: 'post',
        url: '/supplier/ajax/addSupplier',
        data: fd,
        dataType: 'json',
        processData: false,
        contentType: false,
        cache: false
      }).done(function(res) {
        if (res.code === 20000) {
          alertStartHtml('success', 'ê³µê¸‰ì‚¬ ë“±ë¡ ì™„ë£Œ', 'ê³µê¸‰ì‚¬ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>Slack ìƒì„± í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ë©ë‹ˆë‹¤.')
          .then(function() {
            $('#addSupplierClose').click();
            location.reload();
          });
        } else {
          alertStart('error', 'ê³µê¸‰ì‚¬ ë“±ë¡ ì‹¤íŒ¨', res.message || 'ë“±ë¡ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }).fail(function(xhr) {
        const r = xhr.responseJSON || {};
        alertStart('error', 'ê³µê¸‰ì‚¬ ë“±ë¡ ì‹¤íŒ¨', r.message || 'ë“±ë¡ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
    });
  }

  /**
   * ===========================================
   *  ìˆ˜ì •: í”„ë¦¬í•„/ê²€ì¦/ì €ì¥
   * ===========================================
   */
  // ìˆ˜ì • ë²„íŠ¼
  $(document).on('click', '.btn-edit', function (e) {
    e.preventDefault();
    const seq = $(this).data('seq');
    if (!seq) return;
    openEditModal(seq);
  });

  // ê³„ì•½ í† ê¸€(ìˆ˜ì •)
  function toggleContractFieldsEdit() {
    const t = $('#editContractTemplate').val();
    $('#editContractAFields').toggleClass('d-none', t !== 'A');
    $('#editContractBFields').toggleClass('d-none', t !== 'B');
  }
  $(document).on('change', '#editContractTemplate', toggleContractFieldsEdit);

  // ìˆ˜ì • ëª¨ë‹¬ ì˜¤í”ˆ & í”„ë¦¬í•„
  function openEditModal(seq) {
    $.getJSON(`/supplier/ajax/${seq}`, function(res) {
      if (res.code !== 20000) {
        alertStart('error', 'ì¡°íšŒ ì‹¤íŒ¨', 'ê³µê¸‰ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }
      const f = document.getElementById('editSupplierForm');
      const it = res.item || {};
      const d = it.detail || {};

      // ê¸°ë³¸
      f.seq.value = it.seq;
      f.updatedAt.value = it.updatedAt || '';
      f.companyName.value = it.companyName || '';
      f.supplierCode.value = it.supplierCode || '';
      f.supplierID.value = it.supplierID || '';
      f.supplierPW.value = ''; // ë³´ì•ˆìƒ ê³µë€ ìœ ì§€
      f.supplierURL.value = it.supplierURL || '';
      f.manager.value = it.manager || '';
      f.managerRank.value = it.managerRank || '';
      f.number.value = it.number || '';
      f.email.value = it.email || '';

      // ìƒì„¸
      f.businessRegistrationNumber.value = d.businessRegistrationNumber || '';
      $(f.bankCode).val(d.bankCode || '');
      f.accountNumber.value = d.accountNumber || '';

      // ê³„ì•½
      $('#editContractTemplate').val(it.contractTemplate || '');
      $('#editContractPercent').val(it.contractPercent ?? '');
      $('#editContractThreshold').val(it.contractThreshold ?? '');
      $('#editContractPercentUnder').val(it.contractPercentUnder ?? '');
      $('#editContractPercentOver').val(it.contractPercentOver ?? '');
      $('#editContractSkip').prop('checked', String(it.contractSkip || '0') === '1');

      toggleContractFieldsEdit();
      clearErrors(f);
      $('#editSupplier').modal('show');
    }).fail(() => {
      alertStart('error', 'ì¡°íšŒ ì‹¤íŒ¨', 'ê³µê¸‰ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    });
  }

  // ìˆ˜ì • í¼ ë¼ì´ë¸Œ ê²€ì¦ (ë“±ë¡ ë£° ë§¤í•‘)
  const liveValidateEdit = debounce(function(e) {
    const f = document.getElementById('editSupplierForm');
    const name = e.target.name;
    if (!name) return;

    const bridge = {
      companyName: 'supplierCompanyName',
      supplierCode: 'supplierCode',
      supplierID: 'supplierID',
      supplierPW: 'supplierPW',
      supplierURL: 'supplierURL',
      manager: 'supplierManager',
      managerRank: 'supplierManagerRank',
      number: 'supplierNumber',
      email: 'supplierEmail',
      businessRegistrationNumber: 'businessRegistrationNumber',
      bankCode: 'bankCode',
      accountNumber: 'accountNumber'
    };
    const key = bridge[name] || name;
    const formKeyRules = VALIDATION_RULES[key] || DETAIL_RULES[key];
    if (!formKeyRules) return;

    const inputEl = $(f).find(`[name="${name}"]`)[0];
    const raw = (inputEl && inputEl.value ? inputEl.value.trim() : '');

    if (formKeyRules.required && !raw && name !== 'supplierPW') { showFieldError(inputEl, 'í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.'); return; }
    if (!raw) { $(inputEl).removeClass('is-invalid is-valid'); return; }
    if (formKeyRules.max && raw.length > formKeyRules.max) { showFieldError(inputEl, `ìµœëŒ€ ${formKeyRules.max}ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í˜„ì¬ ${raw.length}ì)`); return; }
    if (formKeyRules.minLen && raw.length < formKeyRules.minLen) { showFieldError(inputEl, `ìµœì†Œ ${formKeyRules.minLen}ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.`); return; }
    if (formKeyRules.email && !isValidEmail(raw)) { showFieldError(inputEl, 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
    if (formKeyRules.url && !isValidURL(raw)) { showFieldError(inputEl, 'ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
    if (formKeyRules.biz10 && !isBiz10(raw)) { showFieldError(inputEl, 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ì 10ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
    showFieldValid(inputEl);
  }, 120);
  $(document).on('input change', '#editSupplierForm input, #editSupplierForm select', liveValidateEdit);

  // ìˆ˜ì • ì €ì¥
  function saveEditSupplier() {
    const f = document.getElementById('editSupplierForm');
    clearErrors(f);

    // í•„ìˆ˜/í˜•ì‹ ì²´í¬
    let ok = true;
    if (!f.companyName.value.trim()) { showFieldError(f.companyName, 'í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.'); ok = false; }
    if (!f.supplierID.value.trim() || f.supplierID.value.trim().length < 6) { showFieldError(f.supplierID, 'IDëŠ” 6ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false; }

    // ê³„ì•½ ì²´í¬
    const t = $('#editContractTemplate').val();
    if (t === 'A') {
      const p = $('#editContractPercent').val();
      if (!(p !== '' && isNumber(p) && Number(p) >= 0 && Number(p) <= 100)) {
        showFieldError($('#editContractPercent'), '0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false;
      }
    }
    if (t === 'B') {
      const th = $('#editContractThreshold').val();
      const under = $('#editContractPercentUnder').val();
      const over = $('#editContractPercentOver').val();
      if (!(th !== '' && isInteger(th) && Number(th) >= 0)) { showFieldError($('#editContractThreshold'), '0 ì´ìƒì˜ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false; }
      if (!(under !== '' && isNumber(under) && Number(under) >= 0 && Number(under) <= 100)) { showFieldError($('#editContractPercentUnder'), '0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false; }
      if (!(over !== '' && isNumber(over) && Number(over) >= 0 && Number(over) <= 100)) { showFieldError($('#editContractPercentOver'), '0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); ok = false; }
    }

    // ìƒì„¸ ì²´í¬(ì„ íƒì´ì§€ë§Œ í˜•ì‹ ë³´ì •)
    const biz = f.businessRegistrationNumber.value;
    if (biz && !isBiz10(biz)) { showFieldError(f.businessRegistrationNumber, 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ì 10ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.'); ok = false; }
    if (!ok) {
      Swal.fire({ icon: 'error', title: 'ì…ë ¥ê°’ í™•ì¸ í•„ìš”', text: 'ë¹¨ê°„ í‘œì‹œëœ í•­ëª©ì„ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.' });
      return;
    }

    const payload = {
      seq: f.seq.value,
      updatedAt: f.updatedAt.value,
      companyName: f.companyName.value.trim(),
      supplierCode: f.supplierCode.value.trim(),
      supplierID: f.supplierID.value.trim(),
      supplierPW: f.supplierPW.value.trim(), // ê³µë€ì´ë©´ ì„œë²„ì—ì„œ ë¬´ì‹œ
      supplierURL: f.supplierURL.value.trim(),
      manager: f.manager.value.trim(),
      managerRank: f.managerRank.value.trim(),
      number: f.number.value.trim(),
      email: f.email.value.trim(),
      // ìƒì„¸
      businessRegistrationNumber: biz,
      bankCode: f.bankCode.value,
      accountNumber: f.accountNumber.value.trim(),
      // ê³„ì•½
      contractTemplate: t,
      contractPercent: $('#editContractPercent').val(),
      contractThreshold: $('#editContractThreshold').val(),
      contractPercentUnder: $('#editContractPercentUnder').val(),
      contractPercentOver: $('#editContractPercentOver').val(),
      contractSkip: $('#editContractSkip').is(':checked') ? '1' : '0'
    };

    $.ajax({
      url: '/supplier/ajax/update',
      method: 'POST',
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify(payload)
    }).done(function(res) {
      if (res.code === 20000) {
        alertStart('success', 'ìˆ˜ì • ì™„ë£Œ', 'ê³µê¸‰ì‚¬ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')
        .then(function () {
          $('#editSupplier').modal('hide');
          location.reload();
        });
      } else if (res.code === 40900) {
        alertStart('warning', 'ë™ì‹œ ìˆ˜ì • ê°ì§€', res.message || 'ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë¨¼ì € ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      } else if (res.code === 40001) {
        alertStart('error', 'ê²€ì¦ ì‹¤íŒ¨', 'ì…ë ¥ê°’ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      } else {
        alertStart('error', 'ì €ì¥ ì‹¤íŒ¨', res.message || 'ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }).fail(function(xhr) {
      const r = xhr.responseJSON || {};
      alertStart('error', 'ì €ì¥ ì‹¤íŒ¨', r.message || 'ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }

  // ê³„ì•½ì„œ ì¬ë°œì†¡
  $(document).on('click', '.btn-resend', function (e) {
    e.preventDefault();
    const seq = $(this).data('seq');
    if (!seq) return;

    Swal.fire({
      icon: 'warning',
      title: 'ê³„ì•½ì„œ ì¬ë°œì†¡',
      text: 'í•´ë‹¹ ê³µê¸‰ì‚¬ì— ê³„ì•½ì„œë¥¼ ë‹¤ì‹œ ë°œì†¡í• ê¹Œìš”?',
      showCancelButton: true,
      confirmButtonText: 'ì¬ë°œì†¡',
      cancelButtonText: 'ì·¨ì†Œ',
      reverseButtons: true
    }).then((res) => {
      if (!res.isConfirmed) return;

      $.ajax({
        url: '/supplier/ajax/contract/resend',
        method: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({ seq })
      }).done((r) => {
        if (r.code === 20000) {
          alertStart('success', 'ì¬ë°œì†¡ ìš”ì²­ ì™„ë£Œ', 'ê³„ì•½ì„œ ì¬ë°œì†¡ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.')
          .then(function () { location.reload(); });
        } else {
          alertStart('error', 'ì¬ë°œì†¡ ì‹¤íŒ¨', r.message || 'ê³„ì•½ì„œ ì¬ë°œì†¡ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }).fail(() => {
        alertStart('error', 'ì¬ë°œì†¡ ì‹¤íŒ¨', 'ê³„ì•½ì„œ ì¬ë°œì†¡ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
    });
  });

  // í˜ì´ì§€ ë¡œë“œ í›…(í•„ìš” ì‹œ)
  $(function(){});

  // ===========================================
  //  ì •ì‚°ì„œ ì¬ë°œí–‰: ëª¨ë‹¬ ì˜¤í”ˆ
  // ===========================================
  $(document).on('click', '.btn-settlement-reissue', function (e) {
    e.preventDefault();
    const $btn = $(this);

    const supplyId = $btn.data('supplyId');
    const channel = $btn.data('channel');
    const company = $btn.data('company') || '';

    if (!supplyId || !channel) {
      Swal.fire({
        icon: 'error',
        title: 'ì •ë³´ ë¶€ì¡±',
        text: 'ê³µê¸‰ì‚¬ ì½”ë“œ ë˜ëŠ” Slack ì±„ë„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.'
      });
      return;
    }

    const $modal = $('#settlementReissueModal');
    $modal.find('input[name="supplyId"]').val(supplyId);
    $modal.find('input[name="channel"]').val(channel);
    $modal.find('.js-company-name').text(company);

    // ë‚ ì§œ ì´ˆê¸°í™”
    $modal.find('input[name="start"]').val('');
    $modal.find('input[name="end"]').val('');

    $modal.modal('show');
  });

  // ===========================================
  //  ì •ì‚°ì„œ ì¬ë°œí–‰: ì‹¤í–‰ í•¨ìˆ˜
  // ===========================================
  function runSettlementReissue() {
    const $modal = $('#settlementReissueModal');

    const supplyId = $modal.find('input[name="supplyId"]').val();
    const channel = $modal.find('input[name="channel"]').val();
    const start = $modal.find('input[name="start"]').val();
    const end = $modal.find('input[name="end"]').val();

    if (!start || !end) {
      Swal.fire({
        icon: 'error',
        title: 'ì…ë ¥ê°’ í™•ì¸',
        text: 'ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.'
      });
      return;
    }

    if (start > end) {
      Swal.fire({
        icon: 'error',
        title: 'ê¸°ê°„ ì˜¤ë¥˜',
        text: 'ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ì´í›„ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
      return;
    }

    Swal.fire({
      icon: 'warning',
      title: 'ì •ì‚°ì„œ ì¬ë°œí–‰',
      text: 'í•´ë‹¹ ê¸°ê°„ì˜ ì •ì‚°ì„œë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì—¬ Slackìœ¼ë¡œ ë°œì†¡í• ê¹Œìš”?',
      showCancelButton: true,
      confirmButtonText: 'ì¬ë°œí–‰',
      cancelButtonText: 'ì·¨ì†Œ',
      reverseButtons: true
    }).then((res) => {
      if (!res.isConfirmed) return;

      // ë¡œë”© í‘œì‹œ
      Swal.fire({
        title: 'ì •ì‚°ì„œ ìƒì„± ì¤‘...',
        html: 'Slackìœ¼ë¡œ ì •ì‚°ì„œë¥¼ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      $.ajax({
        url: '/api/settlement/run',       // â¬… ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ ê²½ë¡œ
        method: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({
          supply_id: supplyId,
          channel: channel,
          start: start,
          end: end
        })
      }).done(function (res) {
        if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: 'ì •ì‚°ì„œ ì¬ë°œí–‰ ì™„ë£Œ',
            html: 'Slack ì±„ë„ë¡œ ì •ì‚°ì„œê°€ ë‹¤ì‹œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
          }).then(function () {
            $modal.modal('hide');
            // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ location.reload() ì¶”ê°€ ê°€ëŠ¥
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'ì •ì‚°ì„œ ì¬ë°œí–‰ ì‹¤íŒ¨',
            text: res.message || 'ì •ì‚°ì„œ ì¬ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
          });
        }
      }).fail(function (xhr) {
        const r = xhr.responseJSON || {};
        Swal.fire({
          icon: 'error',
          title: 'ì •ì‚°ì„œ ì¬ë°œí–‰ ì‹¤íŒ¨',
          text: r.message || 'ì •ì‚°ì„œ ì¬ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        });
      });
    });
  }
</script>

<body id="page-top">
  <div id="wrapper">
    {% include './common/sidebar.html' %}

    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <div class="container-fluid">

          <h1 class="h3 mb-2 text-gray-800">ê³µê¸‰ì‚¬ ê´€ë¦¬</h1>
          <p class="mb-4">
            ê³µê¸‰ì‚¬ ë“±ë¡, ìˆ˜ì • ë° ê³„ì•½ì„œ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.<br>
            ì‹ ê·œ ê³µê¸‰ì‚¬ë¥¼ ë“±ë¡í•˜ë©´ Slack ì±„ë„ì´ ìë™ ìƒì„±ë˜ê³ , ê³„ì•½ ì§„í–‰ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>

          <div class="card shadow mb-4" style="zoom:0.9;">
            <div class="card-header py-3 d-sm-flex align-items-center justify-content-between">
              <h6 class="m-0 font-weight-bold text-primary">ê³µê¸‰ì‚¬ ë¦¬ìŠ¤íŠ¸</h6>
              <a class="d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                 href="javascript:resetForm()"
                 data-toggle="modal" data-target="#addSupplier">ê³µê¸‰ì‚¬ ë“±ë¡</a>
            </div>

            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered text-center" id="dataTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>No</th>
                      <th>íšŒì‚¬ëª…</th>
                      <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                      <th>CAFE24 ì½”ë“œ</th>
                      <th>Slack</th>
                      <th>ê³„ì•½ì„œ ì‘ì„±ì—¬ë¶€</th>
                      <th>ê³µê¸‰ì‚¬ ID</th>
                      <th>ë‹´ë‹¹ìëª…</th>
                      <th>ì§ì±…</th>
                      <th>ì—°ë½ì²˜</th>
                      <th>ì´ë©”ì¼</th>
                      <th>ì •ì‚°ì€í–‰</th>
                      <th>ê³„ì¢Œë²ˆí˜¸</th>
                      <th>ê¸°ëŠ¥</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for supplier in supplierList %}
                      <tr data-seq="{{ supplier.seq }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ supplier.companyName }}</td>
                        <td>{{ supplier.detail.businessRegistrationNumber | bizno_format }}</td>
                        <td><div class="btn-sm btn-secondary no-hover">{{ supplier.supplierCode }}</div></td>
                        <td>
                          {% if supplier.stateCode == 'E' %}
                          <div class="btn-sm btn-danger no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% elif supplier.stateCode == 'P' %}
                          <div class="btn-sm btn-primary no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% elif supplier.stateCode == 'I' %}
                          <div class="btn-sm btn-warning no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% else %}
                          <div class="btn-sm btn-info no-hover">{{ supplier.stateCode | state_text }}</div>
                          {% endif %}
                        </td>
                        <td>
                          {% if supplier.contractStatus in ['SS', 'S'] %}
                            <div class="btn-sm btn-info no-hover">{{ supplier.contractStatus | contractState_text }}</div>
                          {% elif supplier.contractStatus in ['P', 'A'] %}
                            <div class="btn-sm btn-primary no-hover">{{ supplier.contractStatus | contractState_text }}</div>
                          {% elif supplier.contractStatus == 'E' %}
                            <button class="btn btn-sm btn-warning ml-1 btn-resend"
                                    data-seq="{{ supplier.seq }}" title="ê³„ì•½ì„œ ì¬ë°œì†¡">
                              ê³„ì•½ì„œ ì¬ë°œì†¡
                            </button>
                          {% else %}
                            {{ supplier.contractStatus | contractState_text }}
                          {% endif %}
                        </td>
                        <td>{{ supplier.supplierID }}</td>
                        <td>{{ supplier.manager }}</td>
                        <td>{{ supplier.managerRank }}</td>
                        <td>{{ supplier.number }}</td>
                        <td>{{ supplier.email }}</td>
                        <td>{{ supplier.detail.bankCode | bankState_text }}</td>
                        <td>{{ supplier.detail.accountNumber }}</td>
                        <td>
                          <a href="#"
                             class="d-sm-inline-block btn btn-sm btn-primary shadow-sm btn-edit"
                             data-seq="{{ supplier.seq }}">ìˆ˜ì •</a>
                          <!-- ğŸ”¹ ì •ì‚°ì„œ ì¬ë°œí–‰ ë²„íŠ¼ ì¶”ê°€ -->
                          <button type="button"
                            class="d-sm-inline-block btn btn-sm btn-outline-secondary ml-1 btn-settlement-reissue"
                            data-supply-id="{{ supplier.supplierCode }}"
                            data-channel="{{ supplier.channelId }}"
                            data-company="{{ supplier.companyName }}">
                          ì •ì‚°ì„œ ì¬ë°œí–‰
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>

      {% include './common/copyright.html' %}
    </div>
  </div>

  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- ë“±ë¡ ëª¨ë‹¬ -->
  <div class="modal fade" id="addSupplier" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">ê³µê¸‰ì‚¬ ë“±ë¡</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span>Ã—</span></button>
        </div>

        <div class="modal-body">
          <form class="supplierForm" id="supplierForm" novalidate>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierCompanyName" name="supplierCompanyName" placeholder="íšŒì‚¬ëª…" maxlength="20" required>
              <div class="invalid-feedback">íšŒì‚¬ëª…ì€ í•„ìˆ˜ì´ë©° ìµœëŒ€ 20ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierCode" name="supplierCode" placeholder="CAFE24 ì½”ë“œ" maxlength="20" required>
              <div class="invalid-feedback">Cafe24 ì½”ë“œëŠ” í•„ìˆ˜ì´ë©° ìµœëŒ€ 20ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierID" name="supplierID" placeholder="ê³µê¸‰ì‚¬ ID(ìµœì†Œ 6ì)" minlength="6" required>
              <div class="invalid-feedback">ê³µê¸‰ì‚¬ IDëŠ” ìµœì†Œ 6ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierPW" name="supplierPW" placeholder="ê³µê¸‰ì‚¬ PW" maxlength="100">
              <div class="invalid-feedback">PWëŠ” ìµœëŒ€ 100ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierURL" name="supplierURL" placeholder="ìì‚¬ëª° URL" maxlength="100">
              <div class="invalid-feedback">ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierManager" name="supplierManager" placeholder="ë‹´ë‹¹ìëª…" maxlength="10">
              <div class="invalid-feedback">ë‹´ë‹¹ìëª…ì€ ìµœëŒ€ 10ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierManagerRank" name="supplierManagerRank" placeholder="ì§ì±…" maxlength="500">
              <div class="invalid-feedback">ì§ì±…ì€ ìµœëŒ€ 500ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control form-control-user" id="supplierNumber" name="supplierNumber" placeholder="ì—°ë½ì²˜">
              <div class="invalid-feedback">ìœ íš¨í•œ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
            </div>
            <div class="form-group">
              <input type="email" class="form-control form-control-user" id="supplierEmail" name="supplierEmail" placeholder="ì´ë©”ì¼" maxlength="30">
              <div class="invalid-feedback">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.</div>
            </div>

            <!-- ê³„ì•½(ë“±ë¡) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <label class="small text-muted mb-1">ê³„ì•½ì„œ ì„ íƒ</label>
                <select class="form-control" id="contractTemplate" name="contractTemplate">
                  <option value="">ì„ íƒì•ˆí•¨</option>
                  <option value="A">A. ë‹¨ì¼ ìˆ˜ìˆ˜ë£Œ(%)</option>
                  <option value="B">B. íŠ¹ì •ê¸ˆì•¡ ê¸°ì¤€ êµ¬ê°„ë³„ ìˆ˜ìˆ˜ë£Œ</option>
                </select>
              </div>
              <div id="contractAFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control form-control-user" id="contractPercent" name="contractPercent" placeholder="ìˆ˜ìˆ˜ë£Œ(%)">
                  <div class="invalid-feedback">0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
              </div>
              <div id="contractBFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="1" min="0" class="form-control form-control-user" id="contractThreshold" name="contractThreshold" placeholder="íŠ¹ì • ê¸ˆì•¡(ì›)">
                  <div class="invalid-feedback">0 ì´ìƒì˜ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control form-control-user" id="contractPercentUnder" name="contractPercentUnder" placeholder="ì´í•˜ì¼ ë•Œ ìˆ˜ìˆ˜ë£Œ(%)">
                  <div class="invalid-feedback">0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control form-control-user" id="contractPercentOver" name="contractPercentOver" placeholder="ì´ˆê³¼ì¼ ë•Œ ìˆ˜ìˆ˜ë£Œ(%)">
                  <div class="invalid-feedback">0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
              </div>
              <div class="form-group form-check mt-2">
                <input type="checkbox" class="form-check-input" id="contractSkip" name="contractSkip" value="1">
                <label class="form-check-label" for="contractSkip">ì´ë¯¸ ê³„ì•½ì„œë¥¼ ì œì¶œí•œ ì—…ì²´(ë°œì†¡ ìŠ¤í‚µ)</label>
              </div>
            </div>

            <!-- ì •ì‚°(ë“±ë¡) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <input type="text" class="form-control form-control-user" id="businessRegistrationNumber" name="businessRegistrationNumber" placeholder="ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ (ìˆ«ìë§Œ 10ìë¦¬)" maxlength="12">
                <div class="invalid-feedback">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ì 10ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.</div>
              </div>
              <div class="form-group">
                <select class="form-control" id="bankCode" name="bankCode">
                  <option value="">ì •ì‚°ì€í–‰ ì„ íƒ</option>
                  <option value="088">ì‹ í•œì€í–‰</option>
                  <option value="004">êµ­ë¯¼ì€í–‰</option>
                  <option value="081">í•˜ë‚˜ì€í–‰</option>
                  <option value="011">ë†í˜‘ì€í–‰</option>
                  <option value="020">ìš°ë¦¬ì€í–‰</option>
                </select>
                <div class="invalid-feedback">ì •ì‚°ì€í–‰ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control form-control-user" id="accountNumber" name="accountNumber" placeholder="ê³„ì¢Œë²ˆí˜¸ (ìˆ«ì/â€˜-â€™ í—ˆìš©)" maxlength="30">
                <div class="invalid-feedback">ìœ íš¨í•œ ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" id="addSupplierClose" type="button" data-dismiss="modal">ì·¨ì†Œ</button>
          <a class="btn btn-primary" href="javascript:addSupplier()">ë“±ë¡</a>
        </div>

      </div>
    </div>
  </div>

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="editSupplier" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">ê³µê¸‰ì‚¬ ìˆ˜ì •</h5>
          <button class="close" type="button" data-dismiss="modal"><span>Ã—</span></button>
        </div>

        <div class="modal-body">
          <form id="editSupplierForm" novalidate>
            <input type="hidden" name="seq">
            <input type="hidden" name="updatedAt">

            <div class="form-group">
              <input type="text" class="form-control" name="companyName" placeholder="íšŒì‚¬ëª…" maxlength="20" required>
              <div class="invalid-feedback">íšŒì‚¬ëª…ì€ í•„ìˆ˜ì´ë©° ìµœëŒ€ 20ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="supplierCode" placeholder="CAFE24 ì½”ë“œ" maxlength="20" required>
              <div class="invalid-feedback">CAFE24 ì½”ë“œëŠ” í•„ìˆ˜ì´ë©° ìµœëŒ€ 20ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="supplierID" placeholder="ê³µê¸‰ì‚¬ ID(ìµœì†Œ 6ì)" minlength="6" required>
              <div class="invalid-feedback">ê³µê¸‰ì‚¬ IDëŠ” ìµœì†Œ 6ì ì´ìƒì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="supplierPW" placeholder="ê³µê¸‰ì‚¬ PW(ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)" maxlength="100">
              <div class="invalid-feedback">PWëŠ” ìµœëŒ€ 100ìì…ë‹ˆë‹¤.</div>
            </div>

            <div class="form-group">
              <input type="text" class="form-control" name="supplierURL" placeholder="ìì‚¬ëª° URL" maxlength="100">
              <div class="invalid-feedback">ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="manager" placeholder="ë‹´ë‹¹ìëª…" maxlength="10">
              <div class="invalid-feedback">ë‹´ë‹¹ìëª…ì€ ìµœëŒ€ 10ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="managerRank" placeholder="ì§ì±…" maxlength="500">
              <div class="invalid-feedback">ì§ì±…ì€ ìµœëŒ€ 500ìì…ë‹ˆë‹¤.</div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" name="number" placeholder="ì—°ë½ì²˜">
              <div class="invalid-feedback">ìœ íš¨í•œ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
            </div>
            <div class="form-group">
              <input type="email" class="form-control" name="email" placeholder="ì´ë©”ì¼" maxlength="30">
              <div class="invalid-feedback">ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.</div>
            </div>

            <!-- ê³„ì•½(ìˆ˜ì •) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <label class="small text-muted mb-1">ê³„ì•½ì„œ ì„ íƒ</label>
                <select class="form-control" id="editContractTemplate" name="contractTemplate">
                  <option value="">ì„ íƒì•ˆí•¨</option>
                  <option value="A">A. ë‹¨ì¼ ìˆ˜ìˆ˜ë£Œ(%)</option>
                  <option value="B">B. íŠ¹ì •ê¸ˆì•¡ ê¸°ì¤€ êµ¬ê°„ë³„ ìˆ˜ìˆ˜ë£Œ</option>
                </select>
              </div>
              <div id="editContractAFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control" id="editContractPercent" name="contractPercent" placeholder="ìˆ˜ìˆ˜ë£Œ(%)">
                  <div class="invalid-feedback">0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
              </div>
              <div id="editContractBFields" class="d-none">
                <div class="form-group">
                  <input type="number" step="1" min="0" class="form-control" id="editContractThreshold" name="contractThreshold" placeholder="íŠ¹ì • ê¸ˆì•¡(ì›)">
                  <div class="invalid-feedback">0 ì´ìƒì˜ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control" id="editContractPercentUnder" name="contractPercentUnder" placeholder="ì´í•˜ì¼ ë•Œ ìˆ˜ìˆ˜ë£Œ(%)">
                  <div class="invalid-feedback">0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
                <div class="form-group">
                  <input type="number" step="0.01" min="0" max="100" class="form-control" id="editContractPercentOver" name="contractPercentOver" placeholder="ì´ˆê³¼ì¼ ë•Œ ìˆ˜ìˆ˜ë£Œ(%)">
                  <div class="invalid-feedback">0~100 ì‚¬ì´ì˜ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
                </div>
              </div>
              <div class="form-group form-check mt-2">
                <input type="checkbox" class="form-check-input" id="editContractSkip" name="contractSkip" value="1">
                <label class="form-check-label" for="editContractSkip">ì´ë¯¸ ê³„ì•½ì„œë¥¼ ì œì¶œí•œ ì—…ì²´(ë°œì†¡ ìŠ¤í‚µ)</label>
              </div>
            </div>

            <!-- ì •ì‚°(ìˆ˜ì •) -->
            <div class="border-top pt-3 mt-3">
              <div class="form-group">
                <input type="text" class="form-control" name="businessRegistrationNumber" placeholder="ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ (ìˆ«ìë§Œ 10ìë¦¬)" maxlength="12">
                <div class="invalid-feedback">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ì 10ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.</div>
              </div>
              <div class="form-group">
                <select class="form-control" name="bankCode">
                  <option value="">ì •ì‚°ì€í–‰ ì„ íƒ</option>
                  <option value="088">ì‹ í•œì€í–‰</option>
                  <option value="004">êµ­ë¯¼ì€í–‰</option>
                  <option value="081">í•˜ë‚˜ì€í–‰</option>
                  <option value="011">ë†í˜‘ì€í–‰</option>
                  <option value="020">ìš°ë¦¬ì€í–‰</option>
                </select>
                <div class="invalid-feedback">ì •ì‚°ì€í–‰ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control" name="accountNumber" placeholder="ê³„ì¢Œë²ˆí˜¸ (ìˆ«ì/â€˜-â€™ í—ˆìš©)" maxlength="30">
                <div class="invalid-feedback">ìœ íš¨í•œ ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">ì·¨ì†Œ</button>
          <button class="btn btn-primary" id="btnUpdateSupplier" type="button" onclick="saveEditSupplier()">ì €ì¥</button>
        </div>

      </div>
    </div>
  </div>

  <!-- ì •ì‚°ì„œ ì¬ë°œí–‰ ëª¨ë‹¬ -->
  <div class="modal fade" id="settlementReissueModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">ì •ì‚°ì„œ ì¬ë°œí–‰</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span>Ã—</span>
          </button>
        </div>

        <div class="modal-body">
          <!-- ìˆ¨ê²¨ì§„ í•„ë“œ: supply_id / channel -->
          <input type="hidden" name="supplyId">
          <input type="hidden" name="channel">

          <p class="mb-3">
            <strong class="js-company-name"></strong> ê³µê¸‰ì‚¬ì— ëŒ€í•´<br>
            ì„ íƒí•œ ê¸°ê°„ì˜ ì •ì‚°ì„œë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì—¬ Slackìœ¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.
          </p>

          <div class="form-group">
            <label for="settlementStart"><small>ì‹œì‘ì¼</small></label>
            <input type="date" class="form-control" id="settlementStart" name="start">
          </div>
          <div class="form-group">
            <label for="settlementEnd"><small>ì¢…ë£Œì¼</small></label>
            <input type="date" class="form-control" id="settlementEnd" name="end">
          </div>

          <p class="text-muted mb-0">
            - ì´ë¯¸ ë°œì†¡ëœ ê¸°ê°„ê³¼ ê²¹ì¹˜ë”ë¼ë„ ë‹¤ì‹œ ìƒì„±ë©ë‹ˆë‹¤.<br>
          </p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">ì·¨ì†Œ</button>
          <button class="btn btn-primary" type="button" onclick="runSettlementReissue()">ì •ì‚°ì„œ ì¬ë°œí–‰</button>
        </div>

      </div>
    </div>
  </div>

  {% include './common/footer.html' %}
